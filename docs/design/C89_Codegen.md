# C89 Code Generation Infrastructure

This document describes the infrastructure used by the RetroZig compiler to generate C89-compliant source code.

## 1. C89Emitter Class

The `C89Emitter` is the primary interface for writing C89 code to a file. It is designed for efficiency and adherence to the project's technical constraints.

### Key Features:
- **Buffered Output**: Uses a 4KB stack-based buffer to batch writes to the filesystem, minimizing system call overhead without requiring heap allocations in the hot path.
- **Indentation Management**: Maintains a simple indentation level counter and provides a `writeIndent()` helper to ensure consistent code formatting (fixed at 4 spaces).
- **C89-Compliant Comments**: Provides an `emitComment()` helper that ensures all comments use the `/* ... */` style, as `//` comments are not supported in standard C89.
- **Platform Abstraction**: Relies on the `platform.hpp` file I/O primitives, ensuring compatibility with both Win32 (using `kernel32.dll` directly) and POSIX environments.

### Usage in Pipeline:
The `C89Emitter` is typically owned by the `CompilationUnit` and instantiated during the code generation phase.

```cpp
C89Emitter emitter(arena, "output.c");
emitter.emitComment("Generated by RetroZig");
emitter.writeString("int main() {\n");
emitter.indent();
emitter.writeIndent();
emitter.writeString("return 0;\n");
emitter.dedent();
emitter.writeString("}\n");
```

## 2. CVariableAllocator Class

The `CVariableAllocator` manages the allocation and uniquification of C variable names within a function scope. It ensures that all generated identifiers are valid in C89 and compatible with legacy compilers like MSVC 6.0.

### Responsibilities:
- **Keyword Avoidance**: Automatically detects conflicts with the 32 standard C89 keywords (e.g., `int`, `return`, `static`) and prefixes conflicting identifiers with `z_`.
- **Length Enforcement**: Enforces a strict 31-character limit for all identifiers to comply with MSVC 6.0 constraints.
- **Uniquification**: Resolves name collisions within a function by appending numeric suffixes (e.g., `my_var`, `my_var_1`).
- **Sanitization**: Replaces invalid characters in Zig identifiers with underscores to produce valid C identifiers.
- **Temporary Name Generation**: Provides a `generate(base)` method for creating unique names for compiler-generated temporary variables.

### Implementation Details:
- **State Management**: The allocator is designed to be reset via `reset()` at the start of each function body to ensure that names are unique only within their relevant scope.
- **Storage**: Allocated names are interned or copied into the `ArenaAllocator` to avoid manual memory management.

### Example:
Zig name `long_variable_name_exceeding_31_chars` might become `long_variable_name_exceeding_3`.
Zig name `int` becomes `z_int`.
Multiple uses of `tmp` result in `tmp`, `tmp_1`, `tmp_2`, etc.
